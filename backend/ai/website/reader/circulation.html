<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Phi·∫øu M∆∞·ª£n S√°ch - Th∆∞ Vi·ªán</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 40px 0;
      }
      .form-container {
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        padding: 40px;
        max-width: 700px;
        margin: 0 auto;
      }
      .form-header {
        text-align: center;
        margin-bottom: 30px;
      }
      .form-header h2 {
        color: #667eea;
        font-weight: 700;
        margin-bottom: 10px;
      }
      .book-preview {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 25px;
        display: none;
      }
      .book-preview.active {
        display: block;
      }
      .book-preview img {
        width: 100px;
        height: 140px;
        object-fit: cover;
        border-radius: 8px;
      }
      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        padding: 12px 40px;
        border-radius: 25px;
        font-weight: 600;
      }
      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }
      .form-label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 8px;
      }
      .form-control,
      .form-select {
        border-radius: 10px;
        border: 2px solid #e9ecef;
        padding: 12px 16px;
      }
      .form-control:focus,
      .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
      }
      .back-link {
        color: white;
        text-decoration: none;
        font-weight: 600;
        display: inline-block;
        margin-bottom: 20px;
      }
      .back-link:hover {
        color: #f8f9fa;
      }
      .alert-success {
        border-radius: 10px;
        border: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <a href="index.html" class="back-link">‚Üê Quay l·∫°i trang ch·ªß</a>

      <div class="form-container">
        <div class="form-header">
          <h2>üìù Phi·∫øu M∆∞·ª£n S√°ch</h2>
          <p class="text-muted">Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin ƒë·ªÉ m∆∞·ª£n s√°ch</p>
        </div>

        <div
          id="successAlert"
          class="alert alert-success"
          style="display: none"
        >
          <strong>‚úÖ Th√†nh c√¥ng!</strong> ƒêƒÉng k√Ω m∆∞·ª£n s√°ch th√†nh c√¥ng.
          <a href="circulation-history.html" class="alert-link"
            >Xem l·ªãch s·ª≠ m∆∞·ª£n tr·∫£</a
          >
        </div>

        <form id="borrowForm">
          <!-- Ch·ªçn s√°ch -->
          <div class="mb-4">
            <label class="form-label">üìö Ch·ªçn s√°ch mu·ªën m∆∞·ª£n</label>
            <select class="form-select" id="bookSelect" required>
              <option value="">-- Ch·ªçn s√°ch --</option>
            </select>
          </div>

          <!-- Preview s√°ch ƒë√£ ch·ªçn -->
          <div class="book-preview" id="bookPreview">
            <div class="row align-items-center">
              <div class="col-auto">
                <img id="previewImg" src="" alt="Book cover" />
              </div>
              <div class="col">
                <h6 class="mb-1" id="previewTitle"></h6>
                <p class="text-muted mb-1" id="previewAuthor"></p>
                <p class="mb-0">
                  <strong>Gi√°:</strong> <span id="previewPrice"></span>
                </p>
                <p class="mb-0">
                  <strong>C√≤n l·∫°i:</strong>
                  <span id="previewQuantity"></span> cu·ªën
                </p>
              </div>
            </div>
          </div>

          <!-- Ng√†y m∆∞·ª£n -->
          <div class="mb-4">
            <label class="form-label">üìÖ Ng√†y m∆∞·ª£n</label>
            <input type="date" class="form-control" id="borrowDate" required />
          </div>

          <!-- Ng√†y tr·∫£ d·ª± ki·∫øn -->
          <div class="mb-4">
            <label class="form-label">üìÜ Ng√†y tr·∫£ d·ª± ki·∫øn</label>
            <input type="date" class="form-control" id="dueDate" required />
            <small class="text-muted">Th·ªùi gian m∆∞·ª£n t·ªëi ƒëa 30 ng√†y</small>
          </div>

          <!-- Ghi ch√∫ -->
          <div class="mb-4">
            <label class="form-label">üí¨ Ghi ch√∫ (kh√¥ng b·∫Øt bu·ªôc)</label>
            <textarea
              class="form-control"
              id="notes"
              rows="3"
              placeholder="Nh·∫≠p ghi ch√∫ n·∫øu c√≥..."
            ></textarea>
          </div>

          <!-- N√∫t submit -->
          <div class="text-center">
            <button type="submit" class="btn btn-primary btn-lg">
              üéØ ƒêƒÉng k√Ω m∆∞·ª£n s√°ch
            </button>
          </div>
        </form>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // D·ªØ li·ªáu m·∫´u s√°ch (gi·∫£ l·∫≠p t·ª´ API)
      const booksData = [
        {
          id: "book001",
          title: "Clean Code: A Handbook of Agile Software Craftsmanship",
          author: "Robert C. Martin",
          price: "250,000 VNƒê",
          quantity: 5,
          img: "https://images.unsplash.com/photo-1543002588-bfa74002ed7e?w=300&h=400&fit=crop",
        },
        {
          id: "book002",
          title: "The Pragmatic Programmer",
          author: "David Thomas",
          price: "320,000 VNƒê",
          quantity: 3,
          img: "https://images.unsplash.com/photo-1544947950-fa07a98d237f?w=300&h=400&fit=crop",
        },
        {
          id: "book003",
          title: "Design Patterns",
          author: "Gang of Four",
          price: "280,000 VNƒê",
          quantity: 8,
          img: "https://images.unsplash.com/photo-1532012197267-da84d127e765?w=300&h=400&fit=crop",
        },
        {
          id: "book004",
          title: "Harry Potter v√† H√≤n ƒê√° Ph√π Th·ªßy",
          author: "J.K. Rowling",
          price: "180,000 VNƒê",
          quantity: 12,
          img: "https://images.unsplash.com/photo-1621351183012-e2f9972dd9bf?w=300&h=400&fit=crop",
        },
        {
          id: "book005",
          title: "Sapiens: L∆∞·ª£c S·ª≠ Lo√†i Ng∆∞·ªùi",
          author: "Yuval Noah Harari",
          price: "210,000 VNƒê",
          quantity: 6,
          img: "https://images.unsplash.com/photo-1519682337058-a94d519337bc?w=300&h=400&fit=crop",
        },
      ];

      // Kh·ªüi t·∫°o
      const bookSelect = document.getElementById("bookSelect");
      const bookPreview = document.getElementById("bookPreview");
      const borrowForm = document.getElementById("borrowForm");
      const borrowDateInput = document.getElementById("borrowDate");
      const dueDateInput = document.getElementById("dueDate");
      const successAlert = document.getElementById("successAlert");

      // ƒê·∫∑t ng√†y m∆∞·ª£n m·∫∑c ƒë·ªãnh l√† h√¥m nay
      const today = new Date().toISOString().split("T")[0];
      borrowDateInput.value = today;
      borrowDateInput.min = today;

      // ƒê·∫∑t ng√†y tr·∫£ m·∫∑c ƒë·ªãnh l√† 14 ng√†y sau
      const defaultDueDate = new Date();
      defaultDueDate.setDate(defaultDueDate.getDate() + 14);
      dueDateInput.value = defaultDueDate.toISOString().split("T")[0];

      // Load danh s√°ch s√°ch v√†o select
      function loadBooks() {
        booksData.forEach((book) => {
          if (book.quantity > 0) {
            const option = document.createElement("option");
            option.value = book.id;
            option.textContent = `${book.title} - ${book.author}`;
            bookSelect.appendChild(option);
          }
        });
      }

      // Hi·ªÉn th·ªã preview s√°ch
      bookSelect.addEventListener("change", function () {
        const selectedBookId = this.value;
        if (selectedBookId) {
          const book = booksData.find((b) => b.id === selectedBookId);
          if (book) {
            document.getElementById("previewImg").src = book.img;
            document.getElementById("previewTitle").textContent = book.title;
            document.getElementById(
              "previewAuthor"
            ).textContent = `T√°c gi·∫£: ${book.author}`;
            document.getElementById("previewPrice").textContent = book.price;
            document.getElementById("previewQuantity").textContent =
              book.quantity;
            bookPreview.classList.add("active");
          }
        } else {
          bookPreview.classList.remove("active");
        }
      });

      // Ki·ªÉm tra ng√†y tr·∫£ kh√¥ng qu√° 30 ng√†y
      borrowDateInput.addEventListener("change", updateDueDateConstraints);
      dueDateInput.addEventListener("change", validateDueDate);

      function updateDueDateConstraints() {
        const borrowDate = new Date(borrowDateInput.value);
        dueDateInput.min = borrowDateInput.value;

        const maxDueDate = new Date(borrowDate);
        maxDueDate.setDate(maxDueDate.getDate() + 30);
        dueDateInput.max = maxDueDate.toISOString().split("T")[0];
      }

      function validateDueDate() {
        const borrowDate = new Date(borrowDateInput.value);
        const dueDate = new Date(dueDateInput.value);
        const diffDays = Math.ceil(
          (dueDate - borrowDate) / (1000 * 60 * 60 * 24)
        );

        if (diffDays > 30) {
          alert("Th·ªùi gian m∆∞·ª£n kh√¥ng ƒë∆∞·ª£c qu√° 30 ng√†y!");
          const maxDueDate = new Date(borrowDate);
          maxDueDate.setDate(maxDueDate.getDate() + 30);
          dueDateInput.value = maxDueDate.toISOString().split("T")[0];
        }
      }

      // X·ª≠ l√Ω submit form
      borrowForm.addEventListener("submit", function (e) {
        e.preventDefault();

        const formData = {
          readerId: "reader001", // ID ng∆∞·ªùi d√πng hi·ªán t·∫°i (l·∫•y t·ª´ session/localStorage)
          bookId: bookSelect.value,
          borrowDate: borrowDateInput.value,
          dueDate: dueDateInput.value,
          status: "pending", // Tr·∫°ng th√°i ch·ªù nh·∫≠n s√°ch
          notes: document.getElementById("notes").value,
        };

        // L∆∞u v√†o localStorage (gi·∫£ l·∫≠p API)
        let circulations = JSON.parse(
          localStorage.getItem("circulations") || "[]"
        );

        const newCirculation = {
          id: `circ${Date.now()}`,
          ...formData,
          returnDate: null,
          createdAt: new Date().toISOString(),
        };

        circulations.push(newCirculation);
        localStorage.setItem("circulations", JSON.stringify(circulations));

        // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
        successAlert.style.display = "block";
        borrowForm.reset();
        bookPreview.classList.remove("active");
        borrowDateInput.value = today;
        dueDateInput.value = defaultDueDate.toISOString().split("T")[0];

        // Cu·ªôn l√™n ƒë·∫ßu trang
        window.scrollTo({ top: 0, behavior: "smooth" });

        // T·ª± ƒë·ªông ·∫©n th√¥ng b√°o sau 5 gi√¢y
        setTimeout(() => {
          successAlert.style.display = "none";
        }, 5000);
      });

      // Kh·ªüi t·∫°o d·ªØ li·ªáu
      loadBooks();
      updateDueDateConstraints();
    </script>
  </body>
</html>
